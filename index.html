<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visio & Tchat P2P</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
        video { transform: scaleX(-1); } /* Miroir */
        /* Scrollbar fine pour le tchat */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #4B5563; border-radius: 3px; }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <!-- LOGIN -->
    <div id="login" class="w-full max-w-md bg-gray-800 p-6 rounded-xl shadow-xl text-center">
        <h1 class="text-2xl font-bold mb-4 text-teal-400">Visio & Tchat ðŸ’¬</h1>
        <input id="roomId" type="text" placeholder="Nom du salon (ex: apÃ©ro)" 
               class="w-full p-3 mb-4 bg-gray-700 rounded outline-none focus:ring-2 focus:ring-teal-500 text-white">
        <button id="joinBtn" class="w-full bg-teal-600 hover:bg-teal-700 py-3 rounded font-bold transition">
            Rejoindre
        </button>
    </div>

    <!-- APP INTERFACE -->
    <div id="appInterface" class="hidden w-full max-w-5xl flex-col md:flex-row gap-4 h-[85vh]">
        
        <!-- COLONNE GAUCHE : VIDÃ‰OS -->
        <div class="flex-1 flex flex-col gap-4">
            <div class="flex justify-between items-center bg-gray-800 p-3 rounded-lg">
                <span id="status" class="text-yellow-400 font-mono text-sm">En attente...</span>
                <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm transition">Quitter</button>
            </div>
            
            <div class="relative flex-1 bg-black rounded-xl overflow-hidden shadow-lg">
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                <div class="absolute bottom-4 right-4 w-32 h-24 bg-gray-800 rounded-lg border-2 border-gray-600 overflow-hidden">
                    <video id="localVideo" autoplay muted playsinline class="w-full h-full object-cover"></video>
                </div>
            </div>
        </div>

        <!-- COLONNE DROITE : TCHAT -->
        <div class="w-full md:w-80 bg-gray-800 rounded-xl flex flex-col shadow-lg">
            <div class="p-3 border-b border-gray-700 font-bold text-gray-300">Tchat Direct ðŸ”’</div>
            
            <div id="chatBox" class="flex-1 p-3 overflow-y-auto space-y-2 flex flex-col">
                <div class="text-center text-xs text-gray-500 mt-auto">En attente de connexion...</div>
            </div>

            <div class="p-3 border-t border-gray-700 flex gap-2">
                <input id="msgInput" type="text" placeholder="Message..." disabled
                       class="flex-1 bg-gray-700 rounded px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-teal-500 disabled:opacity-50">
                <button id="sendBtn" disabled class="bg-teal-600 hover:bg-teal-700 px-3 py-2 rounded text-sm disabled:opacity-50 transition">âž¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, update, get, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBMuMzxCWG98FJG76wUAbJNUXimc4RKn0E",
            authDomain: "privatevideocall.firebaseapp.com",
            databaseURL: "https://privatevideocall-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "privatevideocall",
            storageBucket: "privatevideocall.firebasestorage.app",
            messagingSenderId: "802974624484",
            appId: "1:802974624484:web:4fd31c99f533c90bc55af1",
            measurementId: "G-WGW832F810"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
        let localStream = null;
        let dataChannel = null;
        let roomId = null;

        // UI Refs
        const UI = {
            login: document.getElementById('login'),
            app: document.getElementById('appInterface'),
            joinBtn: document.getElementById('joinBtn'),
            roomId: document.getElementById('roomId'),
            localVid: document.getElementById('localVideo'),
            remoteVid: document.getElementById('remoteVideo'),
            status: document.getElementById('status'),
            chatBox: document.getElementById('chatBox'),
            msgInput: document.getElementById('msgInput'),
            sendBtn: document.getElementById('sendBtn')
        };

        // --- DÃ©marrage ---
        UI.joinBtn.onclick = async () => {
            roomId = UI.roomId.value.trim();
            if (!roomId) return alert("Nom requis");

            UI.login.classList.add('hidden');
            UI.app.classList.remove('hidden');
            UI.app.classList.add('flex');

            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            UI.localVid.srcObject = localStream;
            localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

            pc.ontrack = e => {
                UI.remoteVid.srcObject = e.streams[0];
                UI.status.innerText = "âœ… VidÃ©o ConnectÃ©e";
                UI.status.className = "text-green-400 font-bold";
            };

            // Si je suis l'appelÃ©, j'Ã©coute l'arrivÃ©e du DataChannel
            pc.ondatachannel = (event) => {
                setupDataChannel(event.channel);
            };

            joinRoom();
        };

        // --- Logique Signalisation ---
        async function joinRoom() {
            const roomRef = ref(db, 'rooms/' + roomId);
            const snapshot = await get(roomRef);

            if (snapshot.exists() && snapshot.val().offer) {
                // APPELÃ‰
                handleIceCandidates(false);
                const offer = snapshot.val().offer;
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                await update(roomRef, { answer: { type: answer.type, sdp: answer.sdp } });
            } else {
                // APPELANT
                await set(roomRef, {}); 
                handleIceCandidates(true);
                
                // L'appelant CRÃ‰E le canal de donnÃ©es AVANT l'offre
                dataChannel = pc.createDataChannel("chat");
                setupDataChannel(dataChannel);

                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                await set(roomRef, { offer: { type: offer.type, sdp: offer.sdp } });

                onValue(child(roomRef, 'answer'), (snap) => {
                    if (!pc.currentRemoteDescription && snap.val()) {
                        pc.setRemoteDescription(new RTCSessionDescription(snap.val()));
                    }
                });
            }
        }

        // --- Gestion du Tchat (DataChannel) ---
        function setupDataChannel(channel) {
            dataChannel = channel;
            dataChannel.onopen = () => {
                UI.msgInput.disabled = false;
                UI.sendBtn.disabled = false;
                UI.chatBox.innerHTML = '<div class="text-center text-green-400 text-xs my-2">-- Tchat connectÃ© --</div>';
            };
            dataChannel.onmessage = (event) => addMessage(event.data, 'received');
        }

        function sendMessage() {
            const text = UI.msgInput.value.trim();
            if (text && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(text);
                addMessage(text, 'sent');
                UI.msgInput.value = '';
            }
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            const isMe = type === 'sent';
            div.className = `max-w-[85%] p-2 rounded-lg text-sm ${isMe ? 'bg-teal-600 self-end ml-auto' : 'bg-gray-700 self-start'}`;
            div.textContent = text;
            UI.chatBox.appendChild(div);
            UI.chatBox.scrollTop = UI.chatBox.scrollHeight;
        }

        // Listeners Tchat
        UI.sendBtn.onclick = sendMessage;
        UI.msgInput.onkeypress = (e) => e.key === 'Enter' && sendMessage();

        // --- ICE Candidates ---
        function handleIceCandidates(isCaller) {
            const myIce = ref(db, `rooms/${roomId}/${isCaller ? 'callerIce' : 'calleeIce'}`);
            const remoteIce = ref(db, `rooms/${roomId}/${isCaller ? 'calleeIce' : 'callerIce'}`);
            pc.onicecandidate = e => e.candidate && push(myIce, e.candidate.toJSON());
            onValue(remoteIce, s => s.forEach(c => pc.addIceCandidate(new RTCIceCandidate(c.val())).catch(console.error)));
        }
    </script>
</body>
</html>


    
